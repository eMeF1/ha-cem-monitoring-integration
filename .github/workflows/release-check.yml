name: Release version check

on:
  push:
    tags:
      - "v*"

jobs:
  check-version:
    name: Ensure tag matches manifest version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag
        run: |
          # GITHUB_REF_NAME is like "v0.1.1"
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          echo "tag_version=${TAG_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Read version from manifest.json
        id: manifest
        run: |
          MANIFEST_VERSION=$(python - << 'EOF'
          import json
          from pathlib import Path

          manifest_path = Path("custom_components/cem_monitor/manifest.json")
          data = json.loads(manifest_path.read_text(encoding="utf-8"))
          print(data.get("version", "").strip())
          EOF
          )
          echo "manifest_version=${MANIFEST_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        run: |
          echo "Tag version:      ${{ steps.tag.outputs.tag_version }}"
          echo "Manifest version: ${{ steps.manifest.outputs.manifest_version }}"

          if [ "${{ steps.tag.outputs.tag_version }}" != "${{ steps.manifest.outputs.manifest_version }}" ]; then
            echo "::error::Tag version and manifest.json version do not match."
            exit 1
          fi

      # Optional: auto-create GitHub Release with autogenerated notes
      - name: Create GitHub Release
        if: ${{ success() }}
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}